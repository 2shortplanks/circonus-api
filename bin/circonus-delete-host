#!/usr/bin/env ruby
# Delete a single host (and all associated check bundles, graphs, and rule sets)
# Use FQDN tag to identify it.

require 'circonusutil'

cu = CirconusUtil.new() { |opts,options|
  opts.banner = "Usage: #{File.basename($0)} hostname\n"
  host = ARGV[0]
  if host.nil? or host.empty? then
    puts "Missing hostname!"
    puts opts
    exit -1
  end
}

print "Deleting monitoring for host #{host}\n"
cbs = @c.list_check_bundle({'tags_has'=>"fqdn:#{host.downcase}"})
checks = cbs.map { |m| m['_checks'] }.flatten
graphs = @c.list_graph({'tags_has'=>"fqdn:#{host.downcase}"})
checks.each do |check|
  rule_sets =  @c.list_rule_set({'check'=>check})
  rule_sets.each do |rs|
    @c.delete_rule_set(rs['_cid'])
    puts "Deleting rule set id: #{rs['_cid']}"
  end
end
graphs.each do |graph|
  @c.delete_graph(graph['_cid'])
  puts "Deleting graph id: #{graph['_cid']}"
end
cbs.each do |cb|
  @c.delete_check_bundle(cb['_cid'])
  puts "Deleting check bundle id: #{cb['_cid']}"
end

